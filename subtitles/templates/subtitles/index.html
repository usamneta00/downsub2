{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>يمن سوفت</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.1.0/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
        }

        body {
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
            background: #f8f9fa !important;
            color: #222 !important;
        }

        /* Chat Container */
        #chat-container {
            margin-bottom: 90px !important;
            padding-bottom: 0 !important;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(100vh - 143px);
            background: #fff !important;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        /* Chat Bubbles */
        .chat-bubble {
            background-color: #f1f3f6 !important;
            box-shadow: none !important;
            color: #222 !important;
        }

        .chat-start {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        .chat-start .chat-bubble {
            margin: 0 !important;
            padding: 0 !important;
            border-radius: 12px !important;
            width: 100% !important;
            max-width: 100% !important;
            background-color: transparent !important;
        }

        /* Spacing between chat blocks */
        .chat + .chat {
            margin-top: 12px;
        }

        /* Input Area */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #fff;
            padding-top: 1rem;
            padding-bottom: 1rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.06);
            z-index: 100;
        }

        .input-container {
            position: relative;
        }

        #url-input {
            resize: none;
            min-height: 50px;
            max-height: 150px;
            padding-right: 3rem;
            width: 100%;
            background: #f8f9fa;
            color: #222;
        }

        /* Custom Button */
        .custom-button {
            position: absolute;
            right: 8px;
            bottom: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background-color: #007bff;
            border: none;
            border-radius: 50%;
            transition: background-color 0.3s, transform 0.3s;
            cursor: pointer;
            color: #fff;
        }

        .custom-button:hover {
            background-color: #0056b3;
            transform: translateY(-50%) scale(1.1);
        }

        .custom-button:active {
            background-color: #003d80;
            transform: translateY(-50%) scale(0.95);
        }

        .custom-button svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        /* Icon Container */
        .icon-container {
            position: fixed;
            top: 20px;
            left: 0px;
            z-index: 1000;
        }

        .icon-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            cursor: pointer;
        }

        .article-content {
            font-family: 'Arial', sans-serif;
            font-size: 18px;
            line-height: 1.8;
            color: #000 !important;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            background: #fff;
            padding: 22px 26px; /* تحسين الحواف الداخلية */
            border-radius: 14px; /* زوايا أنعم */
            border: 1px solid #e9ecef; /* إطار خفيف */
            position: relative; /* لإسناد زر النسخ داخل الحاوية */
        }

        /* زر نسخ المحتوى */
        .copy-button {
            position: absolute;
            left: 14px;
            top: 14px;
            padding: 6px 10px;
            font-size: 13px;
            background: #f1f3f6;
            color: #222;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .copy-button:hover {
            background: #e9ecef;
        }
        .copy-button:active {
            transform: scale(0.98);
        }


        
        .article-content h1 {
            font-size: 32px;
            color: #000 !important;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.3em;
            font-weight: bold;
            line-height: 1.25;
            display: block;
            clear: both;
        }
        
        .article-content h2 {
            font-size: 28px;
            color: #000 !important;
            margin-top: 1.3em;
            margin-bottom: 0.7em;
            font-weight: bold;
            line-height: 1.25;
            display: block;
            clear: both;
        }
        
        .article-content h3 {
            font-size: 24px;
            color: #000 !important;
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            font-weight: bold;
            line-height: 1.25;
            display: block;
            clear: both;
        }
        
        .article-content p {
            margin-bottom: 1.2em;
            text-align: justify;
            color: #000 !important;
            font-size: 18px;
            line-height: 1.8;
            display: block;
            clear: both;
        }
        
        .article-content ul, .article-content ol {
            padding-right: 1.8em;
            margin-bottom: 1.2em;
            display: block;
            clear: both;
        }
        
        .article-content li {
            margin-bottom: 0.6em;
            color: #000 !important;
            display: list-item;
        }
        
        .article-content blockquote {
            border-right: 4px solid #e0e0e0;
            padding-right: 1em;
            margin: 1em 0;
            font-style: italic;
            color: #000 !important;
            background: #f8f9fa;
            padding: 1em;
            border-radius: 5px;
            display: block;
            clear: both;
        }
        
        .article-content code {
            background-color: #f1f3f6;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #c7254e !important;
            font-size: 16px;
            display: inline-block;
        }
        
        .article-content pre {
            background-color: #f1f3f6;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 1.2em;
            border: 1px solid #e0e0e0;
            display: block;
            clear: both;
        }
        
        .article-content pre code {
            background-color: transparent;
            padding: 0;
            color: #c7254e !important;
        }
        
        .article-content a {
            color: #007bff !important;
            text-decoration: none;
            border-bottom: 1px dotted #007bff;
            display: inline;
        }
        
        .article-content a:hover {
            border-bottom: 1px solid #007bff;
            color: #0056b3 !important;
        }
        
        .article-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1em auto;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            clear: both;
        }

        /* Form Styling */
        .url-form {
            width: 100%;
        }

        .url-form input[type="url"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: #f8f9fa;
            color: #222;
            transition: border-color 0.3s ease;
        }

        .url-form input[type="url"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .submit-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .submit-button:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .submit-button:active {
            transform: translateY(0);
        }

        p {
            font-family: 'Segoe UI', Arial, sans-serif !important;
            font-size: 16px !important;
            color: #000 !important;
        }
        
        /* تأكيد أن جميع النصوص سوداء */
        .article-content * {
            color: #000 !important;
        }
        
        .article-content h1,
        .article-content h2,
        .article-content h3,
        .article-content p,
        .article-content div,
        .article-content span {
            color: #000 !important;
        }

        /* Progress Overlay */
        .progress-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(255,255,255,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .progress-box {
            background: #fff;
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.08);
            width: min(420px, 90%);
            text-align: center;
            color: #000;
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e9ecef;
            border-top-color: #007bff;
            border-radius: 50%;
            margin: 0 auto 12px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-text {
            margin-bottom: 10px;
            font-size: 16px;
        }
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 999px;
            overflow: hidden;
        }
        .progress-line {
            width: 40%;
            height: 100%;
            background: #007bff;
            border-radius: 999px;
            animation: indeterminate 1.4s ease-in-out infinite;
        }
        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(50%); }
            100% { transform: translateX(200%); }
        }
    </style>
</head>
<body class="bg-base-300">
    <div class="icon-container">
        <a href="{% static 'org-rewrite.html' %}" title="Org Rewrite">
            <img src="{% static 'unnamed.webp' %}" alt="AI Icon" class="icon-image">
        </a>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- تم إزالة قائمة اختيار المساعد -->
    </div>

    <div id="chat-container" class="bg-base-200 rounded-lg shadow-lg">
        {% if original or translated_and_rewritten %}
            <!-- النص الأصلي -->
            {% if original and not translated_and_rewritten %}
            <div class="chat chat-start">
                <div class="chat-bubble">
                    <div class="article-content">
                        <button type="button" id="copy-original-btn" class="copy-button" title="نسخ">نسخ</button>
                        <h3>النص الأصلي:</h3>
                        <div id="original-text">{{ original|safe }}</div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if translated_and_rewritten %}
            <!-- النص المترجم والمعاد صياغته -->
            <div class="chat chat-start">
                <div class="chat-bubble">
                    <div class="article-content reformulation">
                        <h3>النص المترجم والمعاد صياغته:</h3>
                        {{ translated_and_rewritten|safe }}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endif %}
    </div>

    <!-- Progress Overlay -->
    <div id="progress-overlay" class="progress-overlay">
        <div class="progress-box">
            <div class="spinner"></div>
            <div class="progress-text">جاري المعالجة، قد يستغرق ذلك بعض الوقت حسب طول الفيديو...</div>
            <div class="progress-bar"><div class="progress-line"></div></div>
        </div>
    </div>

    <div class="input-area">
        <div class="container mx-auto">
            {% if error %}
            <div class="bg-red-100 text-red-800 p-4 mb-4 rounded">
                {{ error }}
            </div>
            {% endif %}
            {% if not original and not translated_and_rewritten %}
            <form method="post" class="url-form">
                {% csrf_token %}
                <div class="input-container">
                    {{ form.url }}
                    <button type="submit" class="custom-button">
                        <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="paper-plane" class="svg-inline--fa fa-paper-plane" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <path fill="currentColor" d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"></path>
                        </svg>
                    </button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>

    <script>
        // إضافة تنسيقات CSS لـ Markdown
        const style = document.createElement('style');
        style.textContent = `
            .markdown-body {
                font-family: inherit;
                font-size: inherit;
                line-height: inherit;
                padding: 22px;
            }
            .markdown-body h1,
            .markdown-body h2,
            .markdown-body h3,
            .markdown-body h4,
            .markdown-body h5,
            .markdown-body h6 {
                margin-top: 1.5em;
                margin-bottom: 0.8em;
                font-weight: bold;
                line-height: 1.25;
                color: #000 !important;
                border-bottom: 2px solid #e0e0e0;
                padding-bottom: 0.3em;
            }
            .markdown-body h1 { font-size: 32px; }
            .markdown-body h2 { font-size: 28px; }
            .markdown-body h3 { font-size: 24px; }
            .markdown-body h4 { font-size: 20px; }
            .markdown-body p {
                margin-bottom: 1.2em;
                color: #000 !important;
                line-height: 1.8;
                text-align: justify;
                font-size: 18px;
            }
            .markdown-body ul,
            .markdown-body ol {
                padding-right: 1.8em;
                margin-bottom: 1.2em;
            }
            .markdown-body li {
                margin-bottom: 0.6em;
                color: #000 !important;
            }
            .markdown-body blockquote {
                border-right: 4px solid #e0e0e0;
                padding-right: 1em;
                margin: 1em 0;
                font-style: italic;
                color: #000 !important;
                background: #f8f9fa;
                padding: 1em;
                border-radius: 5px;
            }
            .markdown-body code {
                background-color: #f1f3f6;
                padding: 0.2em 0.4em;
                border-radius: 3px;
                font-family: 'Courier New', monospace;
                color: #c7254e !important;
            }
            .markdown-body pre {
                background-color: #f1f3f6;
                padding: 1em;
                border-radius: 5px;
                overflow-x: auto;
                margin-bottom: 1.2em;
                border: 1px solid #e0e0e0;
            }
            .markdown-body pre code {
                background-color: transparent;
                padding: 0;
                color: #c7254e !important;
            }
        `;
        document.head.appendChild(style);

        // زر نسخ النص الأصلي إلى الحافظة
        document.addEventListener("click", async function(e) {
            const btn = e.target.closest('#copy-original-btn');
            if (!btn) return;

            const container = document.querySelector('#original-text');
            if (!container) return;

            // استخراج النص كنص عادي بدون وسوم
            const text = container.innerText || container.textContent || '';
            try {
                await navigator.clipboard.writeText(text.trim());
                btn.textContent = '✓ تم النسخ';
                btn.disabled = true;
                setTimeout(() => {
                    btn.textContent = 'نسخ';
                    btn.disabled = false;
                }, 1500);
            } catch (err) {
                // fallback بسيط في حال عدم دعم Clipboard API
                const textarea = document.createElement('textarea');
                textarea.value = text.trim();
                document.body.appendChild(textarea);
                textarea.select();
                try { document.execCommand('copy'); } catch (e) {}
                document.body.removeChild(textarea);
                btn.textContent = '✓ تم النسخ';
                setTimeout(() => { btn.textContent = 'نسخ'; }, 1500);
            }
        });

        // معالجة خاصة للنص العربي المترجم والمعاد صياغته
        document.addEventListener("DOMContentLoaded", function() {
            // البحث عن النص المترجم والمعاد صياغته
            const translatedContent = document.querySelector('.reformulation');
            if (translatedContent) {
                // الحصول على النص الخام
                let rawText = translatedContent.textContent;
                
                // إزالة العنوان "النص المترجم والمعاد صياغته:"
                rawText = rawText.replace('النص المترجم والمعاد صياغته:', '').trim();
                
                // تقسيم النص إلى أجزاء بناءً على العناوين
                let formattedHtml = '';
                let lines = rawText.split('\n');
                let currentParagraph = '';
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    
                    if (line.startsWith('# ')) {
                        // عنوان رئيسي
                        if (currentParagraph) {
                            formattedHtml += `<p>${currentParagraph}</p>`;
                            currentParagraph = '';
                        }
                        formattedHtml += `<h1>${line.substring(2)}</h1>`;
                    } else if (line.startsWith('## ')) {
                        // عنوان فرعي
                        if (currentParagraph) {
                            formattedHtml += `<p>${currentParagraph}</p>`;
                            currentParagraph = '';
                        }
                        formattedHtml += `<h2>${line.substring(3)}</h2>`;
                    } else if (line.startsWith('### ')) {
                        // عنوان فرعي ثالث
                        if (currentParagraph) {
                            formattedHtml += `<p>${currentParagraph}</p>`;
                            currentParagraph = '';
                        }
                        formattedHtml += `<h3>${line.substring(4)}</h3>`;
                    } else if (line) {
                        // محتوى عادي
                        if (currentParagraph) {
                            currentParagraph += ' ' + line;
                        } else {
                            currentParagraph = line;
                        }
                    }
                }
                
                // إضافة الفقرة الأخيرة إذا كانت موجودة
                if (currentParagraph) {
                    formattedHtml += `<p>${currentParagraph}</p>`;
                }
                
                // تطبيق التنسيق
                translatedContent.innerHTML = formattedHtml;
                
                // تطبيق التنسيقات على جميع العناصر
                translatedContent.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(function(heading) {
                    heading.style.color = '#000';
                    heading.style.fontWeight = 'bold';
                    heading.style.marginTop = '1.5em';
                    heading.style.marginBottom = '0.8em';
                    heading.style.borderBottom = '2px solid #e0e0e0';
                    heading.style.paddingBottom = '0.3em';
                    heading.style.fontSize = heading.tagName === 'H1' ? '32px' : 
                                            heading.tagName === 'H2' ? '28px' : 
                                            heading.tagName === 'H3' ? '24px' : '20px';
                });
                
                translatedContent.querySelectorAll('p').forEach(function(paragraph) {
                    paragraph.style.color = '#000';
                    paragraph.style.marginBottom = '1.2em';
                    paragraph.style.textAlign = 'justify';
                    paragraph.style.lineHeight = '1.8';
                    paragraph.style.fontSize = '18px';
                });
            }
            // إظهار واجهة التقدم عند إرسال النموذج
            const formEl = document.querySelector('form.url-form');
            if (formEl) {
                formEl.addEventListener('submit', function() {
                    const overlay = document.getElementById('progress-overlay');
                    if (overlay) { overlay.style.display = 'flex'; }
                });
            }
        });
    </script>
</body>
</html>